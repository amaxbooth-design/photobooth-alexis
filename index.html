<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionnaire de Locations</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; min-height: 100vh; margin: 0; padding: 0; background: #f3f4f6; overflow-x: hidden; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #1e40af; color: white; padding: 1rem 0.75rem; position: sticky; top: 0; z-index: 10; white-space: nowrap; text-align: center; font-size: 0.875rem; font-weight: 600; }
    td { padding: 0.875rem 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 0.875rem; }
    tbody tr:hover { background: #f9fafb; }
    .paid { background: #d1fae5; }
    .paid:hover { background: #a7f3d0 !important; }
    .notpaid { background: #fee2e2; }
    .notpaid:hover { background: #fecaca !important; }
  </style>
</head>
<body>

<div id="app">
  <div class="bg-blue-900 shadow-lg">
    <div class="px-4 py-6 max-w-7xl mx-auto">
      <div class="flex flex-wrap justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white">üìã Mes R√©servations Locations</h1>
          <p class="text-blue-200 mt-1">Gestion compl√®te de mes locations</p>
        </div>
        <div class="flex gap-3 flex-wrap">
          <select id="filtre" onchange="load()" class="px-4 py-2 border-2 rounded-lg bg-white focus:outline-none focus:border-blue-500 cursor-pointer">
            <option value="">Tous les mois</option>
          </select>
          <button onclick="nouveau()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition">+ Nouvelle location</button>
          <button onclick="exportAllHTML()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-bold transition">üìÑ Export HTML</button>
          <button onclick="exportAllPremium()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-3 rounded-lg font-bold transition">‚ú® Premium</button>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white min-h-screen">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>üìÖ Enl√®vement</th>
            <th>üìÖ Restitution</th>
            <th>üë§ Nom Pr√©nom</th>
            <th>üìß Email</th>
            <th>üìû T√©l√©phone</th>
            <th>üìç Adresse</th>
            <th>üé≠ Pseudo</th>
            <th>üìÑ Envoy√©</th>
            <th>‚úÖ Sign√©</th>
            <th>üí∞ Acompte</th>
            <th>üîí Caution</th>
            <th>üé® Template</th>
            <th>üìÜ Agenda</th>
            <th>‚öôÔ∏è Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="14" class="text-center py-8 text-gray-500">Chargement...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl p-8 max-w-4xl w-full max-h-screen overflow-y-auto">
    <h2 class="text-3xl font-bold mb-6 text-blue-900" id="titre">Nouvelle location</h2>
    <div id="form" class="grid md:grid-cols-2 gap-6">
      <input type="hidden" id="id">
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Date d'enl√®vement</label><input type="datetime-local" id="enlevement" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Date de restitution</label><input type="datetime-local" id="restitution" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Nom</label><input type="text" id="nom" placeholder="Nom" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Pr√©nom</label><input type="text" id="prenom" placeholder="Pr√©nom" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Email</label><input type="email" id="email" placeholder="email@example.com" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">T√©l√©phone</label><input type="tel" id="telephone" placeholder="0612345678" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></div>
      <div class="md:col-span-2"><label class="block text-sm font-bold mb-2 text-gray-700">Adresse</label><textarea id="adresse" rows="2" placeholder="Adresse compl√®te" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500" required></textarea></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Pseudo</label><input type="text" id="pseudo" placeholder="Pseudo" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Template</label><select id="template" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500 cursor-pointer"><option value="">Non</option><option value="Oui">Oui</option></select></div>
      <div class="md:col-span-2 flex gap-4">
        <button onclick="save()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg flex-1 transition">üíæ Enregistrer</button>
        <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-lg font-bold text-lg transition">‚ùå Annuler</button>
      </div>
    </div>
  </div>
</div>

<script>
  let locations = [];

  async function load() {
    try {
      const result = await window.storage.get('locations-data');
      if (result && result.value) {
        const data = JSON.parse(result.value);
        locations = data.data || [];
      } else {
        locations = [];
      }
    } catch (error) {
      locations = [];
    }
    
    const filtre = document.getElementById('filtre').value;
    const mois = [...new Set(locations.map(x => x.enlevement?.slice(0, 7)))].filter(Boolean).sort().reverse();
    document.getElementById('filtre').innerHTML = '<option value="">Tous les mois</option>' + mois.map(m => `<option value="${m}" ${filtre === m ? 'selected' : ''}>${new Date(m + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</option>`).join('');
    
    const tbody = document.getElementById('tbody');
    if (locations.length === 0) {
      tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-gray-500">Aucune location trouv√©e</td></tr>';
      return;
    }
    
    tbody.innerHTML = locations.filter(x => !filtre || x.enlevement?.startsWith(filtre)).map(r => {
      const ok = r.contratSigne === 'Oui' && r.acompte === 'Oui';
      const dateEnlevement = r.enlevement ? new Date(r.enlevement).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : '-';
      const dateRestitution = r.restitution ? new Date(r.restitution).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : '-';
      const telephone = tel(r.telephone || '');
      const nomComplet = `${r.nom || ''} ${r.prenom || ''}`.trim();
      return `<tr class="${ok ? 'paid' : 'notpaid'}">
        <td>${dateEnlevement}</td>
        <td>${dateRestitution}</td>
        <td><strong>${nomComplet}</strong></td>
        <td>${r.email || ''}</td>
        <td class="font-mono">${telephone}</td>
        <td style="white-space:normal; max-width:250px;">${r.adresse || ''}</td>
        <td>${r.pseudo || ''}</td>
        <td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer" ${r.contratEnvoye === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'contratEnvoye',this.checked)"></td>
        <td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer" ${r.contratSigne === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'contratSigne',this.checked)"></td>
        <td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer" ${r.acompte === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'acompte',this.checked)"></td>
        <td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer" ${r.caution === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'caution',this.checked)"></td>
        <td>${r.template || ''}</td>
        <td class="text-center">
          <button onclick="syncToGoogle(${r.id})" class="text-2xl hover:scale-110 transition" title="Ajouter √† Google Agenda">üìÜ</button>
        </td>
        <td class="text-center whitespace-nowrap">
          <button onclick='editer(${JSON.stringify(r).replace(/'/g, "\\'"')})' class="text-2xl hover:scale-110 transition mr-2" title="Modifier">‚úèÔ∏è</button>
          <button onclick="supprimer(${r.id})" class="text-2xl hover:scale-110 transition" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  }

  function tel(t) {
    if (!t) return '';
    const str = String(t).replace(/\D/g, '');
    if (str.length === 10) return str.replace(/(\d{2})(?=\d)/g, '$1 ');
    return str;
  }

  async function saveToStorage() {
    try {
      await window.storage.set('locations-data', JSON.stringify({
        success: true,
        data: locations
      }));
    } catch (error) {
      console.error('Erreur de sauvegarde:', error);
    }
  }

  async function maj(id, champ, val) {
    locations = locations.map(loc => 
      loc.id === id ? { ...loc, [champ]: val ? 'Oui' : 'Non' } : loc
    );
    await saveToStorage();
    await load();
  }

  function nouveau() {
    document.getElementById('titre').textContent = 'Nouvelle location';
    document.getElementById('id').value = '';
    document.getElementById('enlevement').value = '';
    document.getElementById('restitution').value = '';
    document.getElementById('nom').value = '';
    document.getElementById('prenom').value = '';
    document.getElementById('email').value = '';
    document.getElementById('telephone').value = '';
    document.getElementById('adresse').value = '';
    document.getElementById('pseudo').value = '';
    document.getElementById('template').value = '';
    document.getElementById('modal').classList.remove('hidden');
  }

  function editer(resa) {
    document.getElementById('titre').textContent = 'Modifier la location';
    document.getElementById('id').value = resa.id;
    document.getElementById('enlevement').value = resa.enlevement;
    document.getElementById('restitution').value = resa.restitution;
    document.getElementById('nom').value = resa.nom || '';
    document.getElementById('prenom').value = resa.prenom || '';
    document.getElementById('email').value = resa.email || '';
    document.getElementById('telephone').value = resa.telephone || '';
    document.getElementById('adresse').value = resa.adresse || '';
    document.getElementById('pseudo').value = resa.pseudo || '';
    document.getElementById('template').value = resa.template || '';
    document.getElementById('modal').classList.remove('hidden');
  }

  async function save() {
    const edit = document.getElementById('id').value;
    const newLoc = {
      id: edit || Date.now(),
      enlevement: document.getElementById('enlevement').value,
      restitution: document.getElementById('restitution').value,
      nom: document.getElementById('nom').value,
      prenom: document.getElementById('prenom').value,
      email: document.getElementById('email').value,
      telephone: document.getElementById('telephone').value,
      adresse: document.getElementById('adresse').value,
      pseudo: document.getElementById('pseudo').value,
      template: document.getElementById('template').value,
      contratEnvoye: edit ? locations.find(l => l.id == edit)?.contratEnvoye || 'Non' : 'Non',
      contratSigne: edit ? locations.find(l => l.id == edit)?.contratSigne || 'Non' : 'Non',
      acompte: edit ? locations.find(l => l.id == edit)?.acompte || 'Non' : 'Non',
      caution: edit ? locations.find(l => l.id == edit)?.caution || 'Oui' : 'Oui',
      eventId: edit ? locations.find(l => l.id == edit)?.eventId || '' : ''
    };

    if (edit) {
      locations = locations.map(loc => loc.id == edit ? newLoc : loc);
    } else {
      locations.push(newLoc);
    }

    await saveToStorage();
    closeModal();
    await load();
    Swal.fire('Succ√®s !', 'Location enregistr√©e', 'success');
  }

  async function supprimer(id) {
    const conf = await Swal.fire({
      title: 'Supprimer ?',
      text: 'Action irr√©versible',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc2626',
      confirmButtonText: 'Oui',
      cancelButtonText: 'Non'
    });
    
    if (conf.isConfirmed) {
      locations = locations.filter(loc => loc.id !== id);
      await saveToStorage();
      await load();
      Swal.fire('Supprim√© !', '', 'success');
    }
  }

  function closeModal() {
    document.getElementById('modal').classList.add('hidden');
  }

  function syncToGoogle(id) {
    const location = locations.find(l => l.id === id);
    if (!location || !location.enlevement || !location.restitution) {
      Swal.fire('Erreur', 'Dates manquantes pour la synchronisation', 'error');
      return;
    }

    const title = `Location - ${location.prenom} ${location.nom}`;
    const details = `Client: ${location.prenom} ${location.nom}
Email: ${location.email}
T√©l: ${location.telephone}
Adresse: ${location.adresse}
Pseudo: ${location.pseudo}`;

    const startDate = new Date(location.enlevement).toISOString().replace(/-|:|\.\d+/g, '');
    const endDate = new Date(location.restitution).toISOString().replace(/-|:|\.\d+/g, '');

    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
    
    window.open(url, '_blank');
  }

  function exportAllHTML() {
    if (locations.length === 0) {
      Swal.fire('Erreur', 'Aucune location √† exporter', 'error');
      return;
    }
    
    locations.forEach(loc => {
      const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location - ${loc.prenom} ${loc.nom}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        .section { margin: 20px 0; }
        .label { font-weight: bold; color: #666; }
        .value { color: #333; margin-left: 10px; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin: 5px; }
        .status-oui { background: #4CAF50; color: white; }
        .status-non { background: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fiche de Location</h1>
        <div class="section">
            <h2>Informations Client</h2>
            <p><span class="label">Nom:</span><span class="value">${loc.nom}</span></p>
            <p><span class="label">Pr√©nom:</span><span class="value">${loc.prenom}</span></p>
            <p><span class="label">Email:</span><span class="value">${loc.email}</span></p>
            <p><span class="label">T√©l√©phone:</span><span class="value">${loc.telephone}</span></p>
            <p><span class="label">Adresse:</span><span class="value">${loc.adresse}</span></p>
            <p><span class="label">Pseudo:</span><span class="value">${loc.pseudo}</span></p>
        </div>
        <div class="section">
            <h2>Dates de Location</h2>
            <p><span class="label">Enl√®vement:</span><span class="value">${loc.enlevement}</span></p>
            <p><span class="label">Restitution:</span><span class="value">${loc.restitution}</span></p>
        </div>
        <div class="section">
            <h2>Statuts</h2>
            <span class="status ${loc.contratEnvoye === 'Oui' ? 'status-oui' : 'status-non'}">Contrat envoy√©: ${loc.contratEnvoye}</span>
            <span class="status ${loc.contratSigne === 'Oui' ? 'status-oui' : 'status-non'}">Contrat sign√©: ${loc.contratSigne}</span>
            <span class="status ${loc.acompte === 'Oui' ? 'status-oui' : 'status-non'}">Acompte: ${loc.acompte}</span>
            <span class="status ${loc.caution === 'Oui' ? 'status-oui' : 'status-non'}">Caution: ${loc.caution}</span>
        </div>
    </div>
</body>
</html>`;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `location_${loc.id}_standard.html`;
      a.click();
      URL.revokeObjectURL(url);
    });
    
    Swal.fire('Succ√®s', `${locations.length} fichier(s) HTML export√©(s)`, 'success');
  }

  function exportAllPremium() {
    if (locations.length === 0) {
      Swal.fire('Erreur', 'Aucune location √† exporter', 'error');
      return;
    }
    
    locations.forEach(loc => {
      const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Premium - ${loc.prenom} ${loc.nom}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
        .container { max-width: 900px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .content { padding: 40px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { color: #667eea; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .info-row { margin: 12px 0; display: flex; align-items: center; }
        .info-label { font-weight: 600; color: #555; min-width: 100px; }
        .info-value { color: #333; flex: 1; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 30px; }
        .status-badge { padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-oui { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .status-non { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .dates-section { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        .date-box { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 10px 0; }
        .footer { text-align: center; padding: 20px; color: #666; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Fiche de Location Premium</h1>
            <p>R√©f√©rence #${loc.id}</p>
        </div>
        <div class="content">
            <div class="dates-section">
                <h3 style="margin-bottom: 15px; font-size: 20px;">üìÖ P√©riode de Location</h3>
                <div class="date-box"><strong>Enl√®vement:</strong> ${loc.enlevement || 'Non d√©fini'}</div>
                <div class="date-box"><strong>Restitution:</strong> ${loc.restitution || 'Non d√©fini'}</div>
            </div>
            <div class="grid">
                <div class="card">
                    <h3>üë§ Informations Client</h3>
                    <div class="info-row"><span class="info-label">Nom:</span><span class="info-value">${loc.nom}</span></div>
                    <div class="info-row"><span class="info-label">Pr√©nom:</span><span class="info-value">${loc.prenom}</span></div>
                    <div class="info-row"><span class="info-label">Pseudo:</span><span class="info-value">${loc.pseudo}</span></div>
                </div>
                <div class="card">
                    <h3>üìû Contact</h3>
                    <div class="info-row"><span class="info-label">Email:</span><span class="info-value">${loc.email}</span></div>
                    <div class="info-row"><span class="info-label">T√©l√©phone:</span><span class="info-value">${loc.telephone}</span></div>
                    <div class="info-row"><span class="info-label">Adresse:</span><span class="info-value">${loc.adresse}</span></div>
                </div>
            </div>
            <div class="card">
                <h3>‚úÖ Statuts & Validations</h3>
                <div class="status-grid">
                    <div class="status-badge ${loc.contratEnvoye === 'Oui' ? 'status-oui' : 'status-non'}">üìÑ Contrat Envoy√©<br>${loc.contratEnvoye}</div>
                    <div class="status-badge ${loc.contratSigne === 'Oui' ? 'status-oui' : 'status-non'}">‚úçÔ∏è Contrat Sign√©<br>${loc.contratSigne}</div>
                    <div class="status-badge ${loc.acompte === 'Oui' ? 'status-oui' : 'status-non'}">üí∞ Acompte<br>${loc.acompte}</div>
                    <div class="status-badge ${loc.caution === 'Oui' ? 'status-oui' : 'status-non'}">üõ°Ô∏è Caution<br>${loc.caution}</div>
                </div>
            </div>
        </div>
        <div class="footer"><p>Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p></div>
    </div>
</body>
</html>`;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `location_${loc.id}_premium.html`;
      a.click();
      URL.revokeObjectURL(url);
    });
    
    Swal.fire('Succ√®s', `${locations.length} fichier(s) Premium export√©(s)`, 'success');
  }

  window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
